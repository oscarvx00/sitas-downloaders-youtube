FROM python:3.8-slim-buster
WORKDIR /sitas-dl-yt-test

RUN pip3 install pytest pytest-mock mock pytest-coverage requests

COPY ./src ./
RUN pip3 install -r requirements.txt

ARG RABBITMQ_ENDPOINT
ARG RABBITMQ_VHOST
ARG RABBITMQ_USER
ARG RABBITMQ_PASS
ARG DOWNLOAD_REQUEST_EXCHANGE
ARG DOWNLOAD_REQUEST_YOUTUBE_QUEUE
ARG DOWNLOAD_COMPLETED_EXCHANGE
ARG MINIO_INTERNAL_ENDPOINT
ARG MINIO_INTERNAL_PORT
ARG MINIO_INTERNAL_USER
ARG MINIO_INTERNAL_PASS
ARG MINIO_INTERNAL_BUCKET
ARG YOUTUBE_API_KEY

ENV RABBITMQ_ENDPOINT=${RABBITMQ_ENDPOINT}
ENV RABBITMQ_VHOST=${RABBITMQ_VHOST}
ENV RABBITMQ_USER=${RABBITMQ_USER}
ENV RABBITMQ_PASS=${RABBITMQ_PASS}
ENV DOWNLOAD_REQUEST_EXCHANGE=${DOWNLOAD_REQUEST_EXCHANGE}
ENV DOWNLOAD_REQUEST_YOUTUBE_QUEUE=${DOWNLOAD_REQUEST_YOUTUBE_QUEUE}
ENV DOWNLOAD_COMPLETED_EXCHANGE=${DOWNLOAD_COMPLETED_EXCHANGE}
ENV MINIO_INTERNAL_ENDPOINT=${MINIO_INTERNAL_ENDPOINT}
ENV MINIO_INTERNAL_PORT=${MINIO_INTERNAL_PORT}
ENV MINIO_INTERNAL_USER=${MINIO_INTERNAL_USER}
ENV MINIO_INTERNAL_PASS=${MINIO_INTERNAL_PASS}
ENV MINIO_INTERNAL_BUCKET=${MINIO_INTERNAL_BUCKET}
ENV YOUTUBE_API_KEY=${YOUTUBE_API_KEY}

ENTRYPOINT [ "python3", "-m", "pytest", "--cov-report", "xml:coverage.xml", "--cov=./" ]